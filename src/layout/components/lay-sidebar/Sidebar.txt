<!-- src/layouts/components/Sidebar/Sidebar.vue -->
<script setup lang="ts">
import type { MenuItemType } from '@/types/menu'
import { computed } from 'vue'
import { useRoute } from 'vue-router'
import BaseMenu from '@/components/Menu/BaseMenu.vue'
import { useUserStore } from '@/store/auth'
import { useAppStore } from '@/store/modules/app'

const route = useRoute()
const appStore = useAppStore()
const userStore = useUserStore()

// 确保 menu 是 MenuItemType[] 类型
const menuItems = computed<MenuItemType[]>(() => userStore.menu || [])

const activeMenu = computed(() => {
  return route.matched.find(match => match.meta?.rank)?.path || route.path
})
const isCollapsed = computed(() => appStore.isCollapsed)
const sidebarMobileOpen = computed(() => appStore.sidebarMobileOpen)

function handleMaskClick() {
  appStore.toggleSidebar(false)
}

function preventPropagation(e: Event) {
  e.stopPropagation()
}
</script>

<template>
  <div
    v-if="appStore.isMobile && sidebarMobileOpen"
    class="sidebar-mask"
    @click="handleMaskClick"
  />
  <div
    class="sidebar-container"
    :class="{ 'is-collapsed': isCollapsed, 'mobile-open': sidebarMobileOpen }"
    @click="preventPropagation"
  >
    <!-- Logo区域 -->
    <div class="sidebar-header">
      <div class="logo-container">
        <PhPhosphorLogo class="logo-icon" />
        <transition name="fade">
          <h1 v-show="!isCollapsed" class="logo-text">
            Phosphor
          </h1>
        </transition>
      </div>
    </div>

    <!-- 菜单 等待 menuItems 加载 -->
    <BaseMenu
      v-if="menuItems.length"
      :items="menuItems"
      :active-path="activeMenu"
      class="sidebar-menu"
      :collapse="isCollapsed"
    />
    <div v-else class="sidebar-loading">
      Loading menu...
    </div>

    <div class="sidebar-footer" />
  </div>
</template>

<style lang="scss" scoped>
@use '../../../styles/layouts/sidebar.scss';
.sidebar-loading {
  padding: 16px;
  color: var(--el-text-color-secondary);
  font-size: 14px;
}
</style>
